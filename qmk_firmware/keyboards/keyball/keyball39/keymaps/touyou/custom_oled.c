#include QMK_KEYBOARD_H

#include "version.h"

// convert number to string
static const char *itoc(uint8_t number, uint8_t width) {
  static char str[5];
  uint8_t i = 0;

  do {
    str[i++] = (number % 10) + '0';
    number /= 10;
  } while (number != 0);

  while (i < width) {
    str[i++] = ' ';
  }

  int len = i;
  for (int j = 0; j < len / 2; j++) {
    char temp = str[j];
    str[j] = str[len - j - 1];
    str[len - j - 1] = temp;
  }
  str[len] = '\0';
  return str;
}

static char to_1x(uint8_t x) {
  x &= 0x0f;
  return x < 10 ? x + '0' : x + 'a' - 10;
}

// CPI, DIV title
static const char PROGMEM img_title[] = {
    0x3e, 0x63, 0x41, 0x41, 0x22, 0x00, 0x7c, 0x14, 0x08, 0x00, 0x74,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x7f,
    0x49, 0x41, 0x22, 0x1c, 0x00, 0x74, 0x00, 0x38, 0x40, 0x38};

bool has_any_pressing_key(void) {
  for (int i = 0; i < KEYBALL_OLED_MAX_PRESSING_KEYCODES; i++) {
    if (keyball.pressing_keys[i] != BL) {
      return true;
    }
  }
  return false;
}

// CPI, scroll, key information
static void print_cpi_status(void) {
  oled_write_raw_P(img_title, sizeof(img_title));
  oled_set_cursor(0, 2);

  oled_write(itoc(keyball_get_cpi(), 0), false);
  oled_write_P(PSTR(" "), false);

  oled_set_cursor(4, 2);
  oled_write_char('0' + keyball_get_scroll_div(), false);

  if (has_any_pressing_key()) {
    oled_set_cursor(0, 4);
    oled_write_P(PSTR(" K"), false);
    oled_write_char(to_1x(keyball.last_kc >> 4), false);
    oled_write_char(to_1x(keyball.last_kc), false);
  }
}

// Lock key status
// static void print_lock_key_status(void) {
//   oled_set_cursor(0, 5);

//   const led_t led_state = host_keyboard_led_state();
//   oled_write_P(led_state.caps_lock ? PSTR("C ") : PSTR("- "), false);
//   oled_write_P(led_state.num_lock ? PSTR("N ") : PSTR("- "), false);
//   oled_write_P(led_state.scroll_lock ? PSTR("S") : PSTR("-"), false);
// }

// 'cat0', 32x32px
static const char PROGMEM img_layer_0[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xfe, 0xfe, 0xfe,
    0xfc, 0xf8, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xfe, 0xfe, 0xfe, 0xfc,
    0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0xfc, 0xfc,
    0xfc, 0xfc, 0x70, 0x01, 0x03, 0x87, 0xc7, 0xe7, 0xe3, 0xf1, 0xf8, 0xf8,
    0xf8, 0xf8, 0xf1, 0xe3, 0xe7, 0xc7, 0x87, 0x03, 0x01, 0x70, 0xfc, 0xfc,
    0xfc, 0xfc, 0x70, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0xc1, 0xf8, 0xfc,
    0xff, 0xff, 0xff, 0xff, 0x0f, 0x03, 0xf9, 0xfd, 0xfd, 0xf9, 0x03, 0x0f,
    0xff, 0xff, 0xff, 0xff, 0xfc, 0xf8, 0xc1, 0x01, 0x01, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x1f, 0x3f, 0x7f, 0x7f, 0x7f, 0xff,
    0xff, 0xfc, 0xf9, 0xfb, 0xfb, 0xf9, 0xfc, 0xff, 0xff, 0x7f, 0x7f, 0x7f,
    0x3f, 0x1f, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00};
// 'cat1', 32x32px
static const char PROGMEM img_layer_1[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xfe, 0xfe, 0xfe,
    0xfc, 0xf8, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xfe, 0xfe, 0xfe, 0xfc,
    0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0xfc, 0xfc,
    0xfc, 0xfc, 0x70, 0x01, 0x03, 0x87, 0xc7, 0xe7, 0xe3, 0xf1, 0xf8, 0xf8,
    0xf8, 0xf8, 0xf1, 0xe3, 0xe7, 0xc7, 0x87, 0x03, 0x01, 0x70, 0xfc, 0xfc,
    0xfc, 0xfc, 0x70, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0xc1, 0xf8, 0xfc,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf3, 0xf9, 0xf9, 0x01, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xfc, 0xf8, 0xc1, 0x01, 0x01, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x1f, 0x3f, 0x7f, 0x7f, 0x7f, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0xff, 0xff, 0xff, 0x7f, 0x7f, 0x7f,
    0x3f, 0x1f, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00};
// 'cat2', 32x32px
static const char PROGMEM img_layer_2[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xfe, 0xfe, 0xfe,
    0xfc, 0xf8, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xfe, 0xfe, 0xfe, 0xfc,
    0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0xfc, 0xfc,
    0xfc, 0xfc, 0x70, 0x01, 0x03, 0x87, 0xc7, 0xe7, 0xe3, 0xf1, 0xf8, 0xf8,
    0xf8, 0xf8, 0xf1, 0xe3, 0xe7, 0xc7, 0x87, 0x03, 0x01, 0x70, 0xfc, 0xfc,
    0xfc, 0xfc, 0x70, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0xc1, 0xf8, 0xfc,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xf3, 0xf9, 0x7d, 0x3d, 0x99, 0xc3, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xfc, 0xf8, 0xc1, 0x01, 0x01, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x1f, 0x3f, 0x7f, 0x7f, 0x7f, 0xff,
    0xff, 0xf9, 0xf8, 0xfa, 0xfb, 0xfb, 0xfb, 0xff, 0xff, 0x7f, 0x7f, 0x7f,
    0x3f, 0x1f, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00};
// 'cat3', 32x32px
static const char PROGMEM img_layer_3[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xfe, 0xfe, 0xfe,
    0xfc, 0xf8, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xfe, 0xfe, 0xfe, 0xfc,
    0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0xfc, 0xfc,
    0xfc, 0xfc, 0x70, 0x01, 0x03, 0x87, 0xc7, 0xe7, 0xe3, 0xf1, 0xf8, 0xf8,
    0xf8, 0xf8, 0xf1, 0xe3, 0xe7, 0xc7, 0x87, 0x03, 0x01, 0x70, 0xfc, 0xfc,
    0xfc, 0xfc, 0x70, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0xc1, 0xf8, 0xfc,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xf9, 0xfd, 0xdd, 0x9d, 0x89, 0x23, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xfc, 0xf8, 0xc1, 0x01, 0x01, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x1f, 0x3f, 0x7f, 0x7f, 0x7f, 0xff,
    0xff, 0xf9, 0xfb, 0xfb, 0xfb, 0xfb, 0xf8, 0xfe, 0xff, 0x7f, 0x7f, 0x7f,
    0x3f, 0x1f, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00};
// 'cat4', 32x32px
static const char PROGMEM img_layer_4[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xfe, 0xfe, 0xfe,
    0xfc, 0xf8, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xfe, 0xfe, 0xfe, 0xfc,
    0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0xfc, 0xfc,
    0xfc, 0xfc, 0x70, 0x01, 0x03, 0x87, 0xc7, 0xe7, 0xe3, 0xf1, 0xf8, 0xf8,
    0xf8, 0xf8, 0xf1, 0xe3, 0xe7, 0xc7, 0x87, 0x03, 0x01, 0x70, 0xfc, 0xfc,
    0xfc, 0xfc, 0x70, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0xc1, 0xf8, 0xfc,
    0xff, 0xff, 0xff, 0xff, 0x7f, 0x1f, 0xcf, 0xf3, 0xf9, 0x01, 0x01, 0xff,
    0xff, 0xff, 0xff, 0xff, 0xfc, 0xf8, 0xc1, 0x01, 0x01, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x1f, 0x3f, 0x7f, 0x7f, 0x7f, 0xff,
    0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xf8, 0xf8, 0xfe, 0xff, 0x7f, 0x7f, 0x7f,
    0x3f, 0x1f, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00};
// 'cat5', 32x32px
static const char PROGMEM img_layer_5[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xfe, 0xfe, 0xfe,
    0xfc, 0xf8, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 0xfe, 0xfe, 0xfe, 0xfc,
    0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x70, 0xfc, 0xfc,
    0xfc, 0xfc, 0x70, 0x01, 0x03, 0x87, 0xc7, 0xe7, 0xe3, 0xf1, 0xf8, 0xf8,
    0xf8, 0xf8, 0xf1, 0xe3, 0xe7, 0xc7, 0x87, 0x03, 0x01, 0x70, 0xfc, 0xfc,
    0xfc, 0xfc, 0x70, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0xc1, 0xf8, 0xfc,
    0xff, 0xff, 0xff, 0xff, 0xff, 0x81, 0xdd, 0xdd, 0xdd, 0xdd, 0x1d, 0x7f,
    0xff, 0xff, 0xff, 0xff, 0xfc, 0xf8, 0xc1, 0x01, 0x01, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x1f, 0x3f, 0x7f, 0x7f, 0x7f, 0xff,
    0xff, 0xf9, 0xfb, 0xfb, 0xfb, 0xf9, 0xfc, 0xff, 0xff, 0x7f, 0x7f, 0x7f,
    0x3f, 0x1f, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00};

// Layer status
static void print_layer_status(void) {
  oled_set_cursor(0, 8);
  switch (get_highest_layer(layer_state)) {
  case 1:
    oled_write_raw_P(img_layer_1, sizeof(img_layer_1));
    oled_set_cursor(0, 13);
    oled_write_P(PSTR("-SYB-"), false);
    break;
  case 2:
    oled_write_raw_P(img_layer_2, sizeof(img_layer_2));
    oled_set_cursor(0, 13);
    oled_write_P(PSTR("-AML-"), false);
    break;
  case 3:
    oled_write_raw_P(img_layer_3, sizeof(img_layer_3));
    oled_set_cursor(0, 13);
    oled_write_P(PSTR("-NUM-"), false);
    break;
  case 4:
    oled_write_raw_P(img_layer_4, sizeof(img_layer_4));
    oled_set_cursor(0, 13);
    oled_write_P(PSTR("-SCR-"), false);
    break;
  case 5:
    oled_write_raw_P(img_layer_5, sizeof(img_layer_5));
    oled_set_cursor(0, 13);
    oled_write_P(PSTR("-SUB-"), false);
    break;
  default:
    oled_write_raw_P(img_layer_0, sizeof(img_layer_0));
    oled_set_cursor(0, 13);
    oled_write_P(PSTR("-DEF-"), false);
    break;
  }
}

static const char PROGMEM img_scroll_up[] = {
    0x00, 0x80, 0x80, 0xc0, 0xc0, 0x60, 0x60, 0x30, 0x30, 0x18, 0x18,
    0x0c, 0x0c, 0x86, 0x86, 0xc3, 0xc3, 0x86, 0x86, 0x0c, 0x0c, 0x18,
    0x18, 0x30, 0x30, 0x60, 0x60, 0xc0, 0xc0, 0x80, 0x80, 0x00, 0xc3,
    0x61, 0x61, 0x30, 0x30, 0x18, 0x18, 0x0c, 0x0c, 0x06, 0x06, 0x03,
    0x03, 0x01, 0x01, 0x00, 0x00, 0x01, 0x01, 0x03, 0x03, 0x06, 0x06,
    0x0c, 0x0c, 0x18, 0x18, 0x30, 0x30, 0x61, 0x61, 0xc3};
static const char PROGMEM img_scroll_down[] = {
    0xc3, 0x86, 0x86, 0x0c, 0x0c, 0x18, 0x18, 0x30, 0x30, 0x60, 0x60,
    0xc0, 0xc0, 0x80, 0x80, 0x00, 0x00, 0x80, 0x80, 0xc0, 0xc0, 0x60,
    0x60, 0x30, 0x30, 0x18, 0x18, 0x0c, 0x0c, 0x86, 0x86, 0xc3, 0x00,
    0x01, 0x01, 0x03, 0x03, 0x06, 0x06, 0x0c, 0x0c, 0x18, 0x18, 0x30,
    0x30, 0x61, 0x61, 0xc3, 0xc3, 0x61, 0x61, 0x30, 0x30, 0x18, 0x18,
    0x0c, 0x0c, 0x06, 0x06, 0x03, 0x03, 0x01, 0x01, 0x00};
static const char PROGMEM img_scroll_no[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

// Scroll status
static void print_scroll_status(void) {
  oled_set_cursor(0, 6);
  oled_write_raw_P(keyball.scroll_mode ? img_scroll_up : img_scroll_no,
                   sizeof(img_scroll_no));
  oled_set_cursor(0, 14);
  oled_write_raw_P(keyball.scroll_mode ? img_scroll_down : img_scroll_no,
                   sizeof(img_scroll_no));
}

// Default page
static void render_default(void) {
  print_cpi_status();
  // print_lock_key_status();
  print_layer_status();
  print_scroll_status();
}

static const char PROGMEM img_logo[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x0e, 0x3c, 0x3c,
    0x3c, 0x78, 0x78, 0x78, 0x70, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xe0, 0xc0,
    0xc0, 0xc0, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xe0, 0xe0, 0xf0, 0xf8,
    0xf8, 0x7c, 0x7c, 0x3e, 0x3f, 0x1f, 0x0f, 0x8f, 0x87, 0xc7, 0xc3, 0xe3,
    0xe1, 0x11, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xc0, 0xc0, 0xc0, 0xc0,
    0xc0, 0x80, 0x80, 0x80, 0x03, 0x01, 0x11, 0x70, 0xf8, 0xf8, 0xe0, 0x80,
    0x06, 0x0f, 0x3f, 0xff, 0xff, 0xff, 0x7f, 0x0f, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x03, 0x03, 0x03, 0x07, 0x07, 0x07,
    0x0f, 0x0f, 0x0f, 0x0e, 0x1f, 0x1f, 0x1f, 0x3f, 0x3f, 0x3c, 0x70, 0x40,
    0x03, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

// Version page
static void render_version(void) {
  oled_write_raw_P(img_logo, sizeof(img_logo));
  oled_set_cursor(0, 6);
  oled_write_P(PSTR("VER.\n"), false);
  oled_write_ln_P(PSTR(TOUYOU_VERSION_STRING), false);
  oled_write_P(PSTR("\n\nQMK.\n"), false);
  oled_write_ln_P(PSTR(QMK_VERSION), false);
}

// Custom OLED rendering function
void keyball_oled_render_custom(void) { render_default(); }

// Custom OLED rendering function for sub display
void keyball_oled_render_custom_sub(void) { render_version(); }
